<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>OpenStreamBot YouTube Overlay</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
            width: 100%;

            body,
            html {
                margin: 0;
                padding: 0;
                overflow: hidden;
                background: #000;
                width: 100%;
                height: 100%;
            }

            #player {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
                display: none;
            }

            #debug {
                position: absolute;
                top: 0;
                left: 0;
                width: 50%;
                background: rgba(0, 0, 0, 0.7);
                color: #0f0;
                font-family: monospace;
                font-size: 14px;
                padding: 10px;
                z-index: 10;
                display: none;
                pointer-events: none;
                /* Hidden by default now, can toggle if needed */
            }
    </style>
</head>

<body>
    <div id="debug">Overlay Ready. Waiting for WS...</div>
    <div id="player"></div>

    <script>
        function log(msg) {
            const d = document.getElementById('debug');
            if (d) {
                d.innerHTML += "<div>" + msg + "</div>";
                if (d.childElementCount > 10) d.removeChild(d.firstChild);
            }
            console.log(msg);
        }

        // 1. YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var queue = [];
        var isPlaying = false;
        var playerReady = false;

        function onYouTubeIframeAPIReady() {
            log("YT API Ready. Creating Player...");
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'fs': 0,
                    'rel': 0,
                    'autoplay': 1,
                    'mute': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            log("Player Ready Event.");
            playerReady = true;
            // Check queue
            if (queue.length > 0) {
                playNext();
            }
        }

        function onPlayerError(event) {
            log("Player Error: " + event.data);
            isPlaying = false;
            // Try next
            if (queue.length > 0) playNext();
        }

        function onPlayerStateChange(event) {
            // ENDED = 0, PLAYING = 1, PAUSED = 2, BUFFERING = 3, CUED = 5
            var stateNames = { 0: "ENDED", 1: "PLAYING", 2: "PAUSED", 3: "BUFFERING", 5: "CUED" };
            var stateName = stateNames[event.data] || event.data;
            log("State Change: " + stateName);

            if (event.data == YT.PlayerState.ENDED) {
                log("Video Ended. Hiding.");
                player.stopVideo();
                document.getElementById('player').style.display = 'none'; // Hide player
                isPlaying = false;

                // Notify Bot
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: "YouTubeEnded", data: {} }));
                }

                // Optional: Play next if queue
                if (queue.length > 0) {
                    playNext();
                } else {
                    // Clear screen (YouTube keeps last frame)
                    // player.clearVideo() is deprecated/not working always, we can reload or just hide
                    // For now, assume it stays on last frame or we could seek to 0 and pause
                }
            } else if (event.data == YT.PlayerState.PLAYING) {
                log("Video Playing.");
                document.getElementById('player').style.display = 'block'; // Show player
            }
        }

        function playNext() {
            if (!playerReady || !player) {
                log("Play requested but player not ready.");
                return;
            }

            var vidId = queue.shift();
            log("Playing ID: " + vidId);

            // Unmute just in case
            try { player.unMute(); } catch (e) { }

            document.getElementById('player').style.display = 'block';
            player.loadVideoById(vidId);
            isPlaying = true;
        }

        // 2. WebSocket Connection
        const ws = new WebSocket("ws://localhost:8080");

        ws.onopen = () => {
            log("WS Connected.");
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.event === "YouTubePlay") {
                    log("Received YouTubePlay: " + msg.data.videoId);
                    queue.push(msg.data.videoId);
                    if (!isPlaying) {
                        playNext();
                    }
                }
            } catch (e) {
                log("WS Error: " + e.message);
            }
        };

        ws.onclose = () => {
            log("WS Disconnected. Reconnecting...");
            setTimeout(() => {
                location.reload();
            }, 3000);
        };
    </script>
</body>

</html>